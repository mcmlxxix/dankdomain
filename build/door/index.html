<!DOCTYPE html>
<html lang="en-US">
<head>
<title>Dank Domain: the return of Hack & Slash</title>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="application-name" content="door">
<meta name="apple-mobile-web-app-title" content="door">
<meta name="msapplication-starturl" content="https://robert.hurst-ri.us/games/dankdomain/door/">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<style type='text/css'>
  body {
    background-color: #102040;
    color: antiquewhite;
  }
  #terminal-container {
    border: 0;
    top: 0; left: 0;
    width: 70%;
    height: 100%;
    position: fixed;
  }
  #Info {
    top: 0; right: 0;
    width: 30%;
    height: 100%;
    position: fixed;
  }
  a:link, a:visited {
    background-color: #0f1e3c;
    color: #eca;
    text-decoration: none;
    display: inline-block;
  }
  a:hover, a:active {
    background-color: #112244;
    color: #ace;
  }
</style>
<link rel="stylesheet" href="build/xterm.css" />
<link rel="stylesheet" href="build/addons/fullscreen/fullscreen.css" />

<script>
if (window.addEventListener) {
    window.addEventListener("message", receive, false);       
}
else {
    if (window.attachEvent) {
        window.attachEvent("onmessage", receive, false);
    }
}

function receive(event) {
  if (event.data) {
    switch(event.data.func) {
      case 'kb':
      case 'emit':
        if (!carrier) {
          term.write('\x1Bc');
          term.destroy();
          pid = 0;
          if (event.data.message == ' ')
            newSession();
          else {
            recheck = 10;
            checkCarrier();
          }
          return;
        }
        if (event.data.message) {
          socket.send(event.data.message);
          if (event.data.return)
            socket.send('\x0A');
        }
        else {
          if (event.data.return)
            socket.send('\x0D');
        }
        break;

    if (event.data.func === 'kb')
        term.focus();
    }
  }
}

function resize() {
  if (!pid) return

  var stylesheet = document.styleSheets[0];
  for (var i in stylesheet.cssRules) {
    css = stylesheet.cssRules[i];
    if (css.selectorText === '#terminal-container')
      l = css;
    if (css.selectorText === '#Info')
      r = css;
  }

  //  possibly shrink font until it can fit 80 columns
  Object.assign(l.style, { 'top':'0%', 'height':'100%', 'width':'70%' });
  Object.assign(r.style, { 'top':'0%', 'height':'100%', 'width':'30%' });
  term.setOption('fontSize', 13);
  while ((fontSize = term.getOption('fontSize')) > 7 && term.proposeGeometry().cols < 85)
    term.setOption('fontSize', --fontSize);

  //  possibly expand side panel without compromising terminal width 
  w = 29;
  do {
    w = (parseInt(w) + 1) + '%';
    v = (100 - parseInt(w)) + '%';
    Object.assign(l.style, { 'top':'0%', 'height':'100%', 'width':v });
    Object.assign(r.style, { 'top':'0%', 'height':'100%', 'width':w });
    xy = term.proposeGeometry();
  } while (xy.cols > 81 && parseInt(w) < 46);

  //  possibly upsize font without compromising terminal width
  while ((xy = term.proposeGeometry()).cols > 81)
    term.setOption('fontSize', ++fontSize);

  //  make it stick
  if (xy.col > 79)
    term.fit();
  else
    term.resize(80, xy.rows);
}

function lurk() {
  if (terminalContainer.hidden) {
    fetch('./watch/', {method: 'POST'}).then(function (res) {
      return res.json().then(function (data) {
        var watch = document.getElementById('watch-list');
        for (var i = watch.options.length - 1; i >= 0; i--)
          watch.remove(i);
        for (var i in data) {
          var option = document.createElement("option");
          option.text = data[i].id;
          option.value = data[i].pid;
          watch.add(option);
        }
        if (watch.options.length) {
          play('chat');
          watch.blur();
        }
        watch.selectedIndex = -1;
      })
    })
  }
}

function watch() {
  var watch = document.getElementById('watch-list');
  var wpid = watch.options[watch.selectedIndex].value;
  //var url = '/terminals/' + pid + '/wall?msg=a lurker is watching you';
  //fetch(url, {method: 'POST'});

  if (pid) {
    term.write('\x1Bc');
    term.destroy();
    pid = 0;
  }

  var stylesheet = document.styleSheets[0];
  for (var i in stylesheet.cssRules) {
    css = stylesheet.cssRules[i];
    if (css.selectorText === '#terminal-container')
      Object.assign(css.style, { 'top':'0%', 'left':'0%', 'height':'100%', 'width':'100%' });
  }

  terminalContainer.hidden = false;
  term = new Terminal({ cursorBlink:false, rows:rows, cols:cols, enableBold:true, scrollback:0,
    fontFamily:'monospace', fontSize:fontSize, theme: {
    foreground:'#c1c2c8', background:'#010208',
    black:'#000000', red:'#a00000', green:'#00a000', yellow:'#c8a000',
    blue:'#0000a0', magenta:'#a000a0', cyan:'#00a0a0', white:'#c8c8c8',
    brightBlack:'#646464', brightRed:'#fa0000', brightGreen:'#00fa00', brightYellow:'#fafa00',
    brightBlue:'#0000fa', brightMagenta:'#fa00fa', brightCyan:'#00fafa', brightWhite:'#fafafa' }
  });

  term.open(terminalContainer);
  term.fit();
  term.winptyCompatInit();

  term.write('\x1B[H\x1B[J\x1B[1;34mConnecting your terminal to ' + watch.options[watch.selectedIndex].text + ' WebSocket ... ');
  protocol = (location.protocol === 'https:') ? 'wss://' : 'ws://';
  socketURL = protocol + location.hostname + ((location.port) ? (':' + location.port) : '') + '/watch/';

  term.on('data', function(data) {
    socket.send(data);
  });

  fetch('./watch/?pid=' + wpid, {method: 'POST'}).then(function (res) {
    res.text().then(function (lurker) {
      //window.pid = pid;
      socketURL += lurker;
      socket = new WebSocket(socketURL);

      socket.onmessage = (ev) => {
        // find any occurrences of @func(data), and for each: call func(data)
        const re = '[@](?:(action|profile|play|tune|wall)[(](.+?)[)])';
        search = new RegExp(re, 'g'); replace = new RegExp(re);
        data = ev.data;
        copy = data;
        while (match = search.exec(copy)) {
          x = replace.exec(data);
          s = x.index; e = s + x[0].length;
          data = data.substr(0, s) + data.substr(e);
          //window[match[1]](match[2]);
        }
        term.write(data);
      };

      socket.onopen = () => {
        term.socket = socket;
        term.focus();
        if (!term.getOption('cursorBlink'))
          term.setOption('cursorBlink', false);
        term.writeln('open\x1B[m');
      };

      socket.onclose = (ev) => {
        term.writeln('\x1B[2mWebSocket close\x1B[m');
        term.destroy();
        wpid = 0;
        terminalContainer.hidden = true;
        lurk();
      };

      socket.onerror = (ev) => {
        term.writeln('\x1B[1;31merror');
      };
    });
  });
}
</script>
</head>
<body onload="resize();" onresize="resize();">
<div id="terminal-container"></div>
<iframe seamless id="Info" name="Info" src="./info.html"></iframe>
<div id="idle-container" hidden=true>
<h2>Dank Domain: the return of Hack &amp; Slash</h2>
<h3>&copy;2017 <a href="https://robert.hurst-ri.us">Robert Hurst</a></h3>
<p>use <button onclick="window.location.reload();"> REFRESH </button> to start over,
or <button onclick="window.history.back();">Go Back</button></p>
<p>Read The Olde Tavern's <a href="./today.txt" target="_blank">news</a></p>
<p>Watch another online player <select id="watch-list" onchange="watch();"></select> <- list refreshes every 30-seconds</p>
<hr>
<table>
<tr><td><img src="images/chrome.png" align="left">&nbsp; Use Google Android tablet or mobile CHROME's<br>&nbsp; <i><b>Add to Home screen</b></i> or <i><b>shelf</b></i> menu option to save as an <b>app</b>
</td></tr>
<tr><td><img src="images/desktop.png" align="left">&nbsp; Desktop Microsoft <b>Edge</b> and Mozilla <b>Firefox</b> browsers also work well.<br>&nbsp; Classic Microsoft Internet Explorer is not supported.
</td></tr>
</table>
<hr>
<a href='http://www.rahcocos.com' target="_blank"><img src="images/promo.png"></a>
</div>
<audio id="play">
    <source id="oggPlay" type="audio/ogg" />
    <source id="mp3Play" type="audio/mp3" />
</audio>
<audio id="tune">
  <source id="oggTune" type="audio/ogg" />
  <source id="mp3Tune" type="audio/mp3" />
</audio>
<script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.1.1/es6-promise.auto.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/1.0.0/fetch.min.js"></script>
<script src="build/xterm.js" ></script>
<script src="build/addons/attach/attach.js" ></script>
<script src="build/addons/fit/fit.js" ></script>
<script src="build/addons/fullscreen/fullscreen.js" ></script>
<script src="build/addons/search/search.js" ></script>
<script src="build/addons/winptyCompat/winptyCompat.js" ></script>
<script src="main.js"></script>
</body>
</html>